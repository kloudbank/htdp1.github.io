(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{503:function(a,s,t){"use strict";t.r(s);var e=t(40),n=Object(e.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"basics"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#basics"}},[a._v("#")]),a._v(" Basics")]),a._v(" "),t("p",[a._v("Flux GitoOps 제품군이며, Kubernetes operating 을 위한 delivery 도구인, flagger 기본 기능 및 Canary custom resource 상세 정리.")]),a._v(" "),t("h2",{attrs:{id:"introduction"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[a._v("#")]),a._v(" Introduction")]),a._v(" "),t("p",[a._v("Flagger 는 k8s 에서 실행되는 application 의 release process 를 자동화하기 위한 도구이다. 신규 version application 의 traffic 을 점진적으로 이동시키며, metric 을 기반으로 적합한지 판단하여 production 에 정상적인 application 이 유지될 수 있도록 promotion 여부를 판단한다.")]),a._v(" "),t("p",[a._v("Flagger는 Traffic Routing 을 위해 Service Mesh (App Mesh, Istio, Linkerd) 혹은 Ingress Controller (Contour, Gloo, NGINX, Skipper, Traefik) 를 사용하여 다양한 배포 전략(Canary 릴리스, A/B 테스트, Blue/Green 미러링)을 구현하는 것이 가능하다.")]),a._v(" "),t("p",[a._v("또한, Release version 의 분석을 위해 Prometheus, Datadog, New Relic, CloudWatch, Graphite를 쿼리할 수 있으며, Alert Provider 를 제공하여 Slack, MS Teams, Discord, Rocket 등에 alert 을 발생하는 것이 가능하다.")]),a._v(" "),t("p",[a._v("Flagger 는 아래 3 가지 Custom Resource 를 활용하여 release process 를 구성한다.")]),a._v(" "),t("ul",[t("li",[t("strong",[a._v("k8s api resources")])])]),a._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("NAME               APIVERSION            NAMESPACED    KIND\n                                                                     \nalertproviders     flagger.app/v1beta1   "),t("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("          AlertProvider\ncanaries           flagger.app/v1beta1   "),t("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("          Canary\nmetrictemplates    flagger.app/v1beta1   "),t("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("          MetricTemplate\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])]),t("p",[a._v("위와 같은 custom resource 구성을 선언적 방식으로 관리하며, k8s event 에 반응하여 동작하기 때문에, 이미 사용하고 있는 Flux, JenkinsX, Carvel, ArgoCD 와 같은 GitOps Pipeline 과 함께 사용하는 것이 가능하다.")]),a._v(" "),t("ul",[t("li",[t("strong",[a._v("Flagger Overview Diagram")]),t("br"),a._v(" "),t("img",{attrs:{src:"https://raw.githubusercontent.com/fluxcd/flagger/main/docs/diagrams/flagger-overview.png"}})])]),a._v(" "),t("blockquote",[t("p",[a._v("Flagger Official Docs. 참고"),t("br"),a._v(" "),t("a",{attrs:{href:"https://docs.flagger.app/",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://docs.flagger.app/"),t("OutboundLink")],1)])]),a._v(" "),t("h2",{attrs:{id:"features"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#features"}},[a._v("#")]),a._v(" Features")]),a._v(" "),t("p",[a._v("아래는 Service Mesh, Ingress Controller 유형 별로 지원 가능한 기능에 대한 정리 내역이다.")]),a._v(" "),t("ul",[t("li",[t("strong",[a._v("Service Mesh")])])]),a._v(" "),t("hr"),a._v(" "),t("p",[a._v("| "),t("small",[a._v("Istio 에서만 가능한 traffic mirroring 의 경우, request traffic 을 copy 하여 Blue / Green 환경에 각각 전송해주는 방식으로, 멱등적이거나 2번 실행하여도 문제가 없는 request 를 활용하여 release version 에 대한 테스트 방식으로 활용할 수 있다.")])]),a._v(" "),t("table",[t("thead",[t("tr",[t("th",[a._v("Deployment Strategy")]),a._v(" "),t("th",[a._v("App Mesh")]),a._v(" "),t("th",[a._v("Istio")]),a._v(" "),t("th",[a._v("Linkerd")]),a._v(" "),t("th",[a._v("SMI")]),a._v(" "),t("th",[a._v("Kubernetes CNI")])])]),a._v(" "),t("tbody",[t("tr",[t("td",[a._v("Canary deployments (weighted traffic)")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("➖")])]),a._v(" "),t("tr",[t("td",[a._v("A/B testing (headers and cookies routing)")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("➖")]),a._v(" "),t("td",[a._v("➖")]),a._v(" "),t("td",[a._v("➖")])]),a._v(" "),t("tr",[t("td",[a._v("Blue/Green deployments (traffic switch)")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")])]),a._v(" "),t("tr",[t("td",[a._v("Blue/Green deployments (traffic mirroring)")]),a._v(" "),t("td",[a._v("➖")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("➖")]),a._v(" "),t("td",[a._v("➖")]),a._v(" "),t("td",[a._v("➖")])])])]),a._v(" "),t("table",[t("thead",[t("tr",[t("th",[a._v("Mertric Check")]),a._v(" "),t("th",[a._v("App Mesh")]),a._v(" "),t("th",[a._v("Istio")]),a._v(" "),t("th",[a._v("Linkerd")]),a._v(" "),t("th",[a._v("SMI")]),a._v(" "),t("th",[a._v("Kubernetes CNI")])])]),a._v(" "),t("tbody",[t("tr",[t("td",[a._v("Request success rate check (L7 metric)")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("➖")]),a._v(" "),t("td",[a._v("➖")])]),a._v(" "),t("tr",[t("td",[a._v("Request duration check (L7 metric)")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("➖")]),a._v(" "),t("td",[a._v("➖")])]),a._v(" "),t("tr",[t("td",[a._v("Custom metric checks")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")])])])]),a._v(" "),t("br"),a._v(" "),t("ul",[t("li",[t("strong",[a._v("Ingress")])])]),a._v(" "),t("hr"),a._v(" "),t("p",[a._v("| "),t("small",[a._v("Service Mesh 에 배포되어 있지 않은 경우, Flagger 는 Kubernetes L4 Networking 을 통하여 traffic 처리할 수 있다.")]),t("br"),a._v(" "),t("small",[a._v("다만, NGINX Ingress Controller 의 경우, L7 metric 기반 request check test 등이 불가능 하다.")])]),a._v(" "),t("table",[t("thead",[t("tr",[t("th",[a._v("Deployment Strategy")]),a._v(" "),t("th",[a._v("Contour")]),a._v(" "),t("th",[a._v("Gloo")]),a._v(" "),t("th",[a._v("NGINX")]),a._v(" "),t("th",[a._v("Skipper")]),a._v(" "),t("th",[a._v("Traefik")])])]),a._v(" "),t("tbody",[t("tr",[t("td",[a._v("Canary deployments (weighted traffic)")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")])]),a._v(" "),t("tr",[t("td",[a._v("A/B testing (headers and cookies routing)")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("➖")]),a._v(" "),t("td",[a._v("➖")])]),a._v(" "),t("tr",[t("td",[a._v("Blue/Green deployments (traffic switch)")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")])])])]),a._v(" "),t("table",[t("thead",[t("tr",[t("th",[a._v("Mertric Check")]),a._v(" "),t("th",[a._v("Contour")]),a._v(" "),t("th",[a._v("Gloo")]),a._v(" "),t("th",[a._v("NGINX")]),a._v(" "),t("th",[a._v("Skipper")]),a._v(" "),t("th",[a._v("Traefik")])])]),a._v(" "),t("tbody",[t("tr",[t("td",[a._v("Request success rate check (L7 metric)")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("➖")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")])]),a._v(" "),t("tr",[t("td",[a._v("Request duration check (L7 metric)")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("➖")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")])]),a._v(" "),t("tr",[t("td",[a._v("Custom metric checks")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")]),a._v(" "),t("td",[a._v("✔️")])])])]),a._v(" "),t("br"),a._v(" "),t("blockquote",[t("p",[a._v("Flagger Github 참조"),t("br"),a._v(" "),t("a",{attrs:{href:"https://github.com/fluxcd/flagger/blob/main/README.md",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://github.com/fluxcd/flagger/blob/main/README.md"),t("OutboundLink")],1)])]),a._v(" "),t("h2",{attrs:{id:"canary-crd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#canary-crd"}},[a._v("#")]),a._v(" Canary CRD")]),a._v(" "),t("p",[a._v("Flagger 의 Canary custom resource 를 생성하여, application release version 의 배포 방식을 정의할 수 있다."),t("br"),a._v("\n아래는 Canary 생성 시 정의하는 항목에 대한 간단한 정리 내역이다.")]),a._v(" "),t("h3",{attrs:{id:"provider"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#provider"}},[a._v("#")]),a._v(" provider")]),a._v(" "),t("p",[a._v("기본적으로, 환경에 맞는 service mesh / ingress controller 를 provider 로 정의한다.")]),a._v(" "),t("ul",[t("li",[a._v("kubernetes, istio, linkerd, appmesh, nginx, skipper, contour, gloo, supergloo, traefik")]),a._v(" "),t("li",[a._v("SMI TrafficSplit: smi:v1alpha1, smi:v1alpha2, smi:v1alpha3")])]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" flagger.app/v1beta1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Canary\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" <name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("provider")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" appmesh"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("v1beta2\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("...")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br")])]),t("h3",{attrs:{id:"target"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#target"}},[a._v("#")]),a._v(" target")]),a._v(" "),t("p",[a._v("targetRef 는 Deployment 와 DaemonSet 으로 지정 가능하다."),t("br"),a._v("\nHPA 가 구성되어 있는 경우, autoscalerRef 에 해당 내용을 정의한다.")]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("targetRef")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" apps/v1\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Deployment\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" <name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("autoscalerRef")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" autoscaling/v2beta2\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" HorizontalPodAutoscaler\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" <name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br")])]),t("p",[a._v("위와 같이 정의한 Canary resource 를 생성하면, 아래처럼 primary deployment, hpa 가 하나씩 더 생성된다.")]),a._v(" "),t("ul",[t("li",[a._v("deployment/<targetRef.name>-primary")]),a._v(" "),t("li",[a._v("hpa/<autoscalerRef.name>-primary")])]),a._v(" "),t("p",[a._v("Flagger 는 위처럼 생성한 primary deployment 를 stable release 로 관리하고, 모든 production traffic 을 primary 로 routing 한다. target 에 정의한 deployment 에서 reference 로 사용하고 있는 configmap, secret 역시 마찬가지로 primary 를 생성한다."),t("br"),a._v("\ntarget 으로 정의된 deployment, configmap, secret 등에 변경이 발생되면, flagger 는 primary 에도 동일한 변경 사항을 반영하기 위한 promotion 을 진행하게 되며, 이 과정에 canary analysis 를 정의하여, promotion 가능 여부를 판단할 수 있다.")]),a._v(" "),t("h3",{attrs:{id:"service"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#service"}},[a._v("#")]),a._v(" service")]),a._v(" "),t("p",[a._v("service 를 정의하여, Canary 의 target deployment 가 cluster 내에서 어떤 형태로 노출되어 있는지 정의해야 한다.")]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("service")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" <name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("9898")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("portName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" http\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("targetPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("9898")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("p",[a._v("위와 같이 정의한 Canary resource 를 생성하면, 아래 처럼 3종류의 service 를 생성한다.")]),a._v(" "),t("ul",[t("li",[t("code",[a._v("<service.name>.<namespace>.svc.cluster.local")]),t("br"),a._v("\n: "),t("code",[a._v("selector app=<name>-primary")])]),a._v(" "),t("li",[t("code",[a._v("<service.name>-primary.<namespace>.svc.cluster.local")]),t("br"),a._v("\n: "),t("code",[a._v("selector app=<name>-primary")])]),a._v(" "),t("li",[t("code",[a._v("<service.name>-canary.<namespace>.svc.cluster.local")]),t("br"),a._v("\n: "),t("code",[a._v("selector app=<name>")])])]),a._v(" "),t("p",[a._v("기본 service / primary service 는 target primary pod 으로 routing 한다. canary analysis 가 진행될 경우, 가중치에 따라 traffic 을 canary service 로 전달하게 되며, 해당 service는 release version 에 의해 생성된 target pod 으로 traffic 을 routing 한다.")]),a._v(" "),t("ul",[t("li",[t("strong",[a._v("Endpoints 예시")])])]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[a._v("NAME                        ENDPOINTS             \naccount                     "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v(".179")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v(".185")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8180")]),a._v("  \naccount"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("canary              "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v(".156")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v(".142")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8180")]),a._v("  \naccount"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("primary             "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v(".179")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v(".185")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8180")]),a._v("  \n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])]),t("p",[a._v("또한, Service Mesh 에 배포되어 있는 flagger 의 경우, 해당하는 추상화된 Object 들을 함께 생성한다.")]),a._v(" "),t("ul",[t("li",[t("strong",[a._v("App Mesh 예시")])])]),a._v(" "),t("p",[a._v("Amazon App Mesh 의 경우, VirtualService 에서 proxy 를 수신하여 가중치 등에 의해 traffic 을 router 로 전달하며, Virtual Rotuter 에서 실제 k8s cluster local service 를 추상화한 Virtual Node 로 분산한다.")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("NAME                                                      ARN                                                                                                    AGE\nvirtualservice.appmesh.k8s.aws/account                    arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualService/account.shop                    26d\nvirtualservice.appmesh.k8s.aws/account-canary             arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualService/account-canary.shop             26d\n\nNAME                                                     ARN                                                                                                   AGE\nvirtualrouter.appmesh.k8s.aws/account                    arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualRouter/account_shop                    26d\nvirtualrouter.appmesh.k8s.aws/account-canary             arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualRouter/account-canary_shop             26d\n\nNAME                                                    ARN                                                                                                  AGE\nvirtualnode.appmesh.k8s.aws/account-canary              arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualNode/account-canary_shop              26d\nvirtualnode.appmesh.k8s.aws/account-primary             arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualNode/account-primary_shop             26d\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br")])]),t("h3",{attrs:{id:"status"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#status"}},[a._v("#")]),a._v(" status")]),a._v(" "),t("p",[a._v("생성된 canary resource 의 status 를 통하여 release process 가 정상적으로 수행되고 있는지 확인할 수 있으며, success / fail 등의 condition 을 status 에서 관리한다.")]),a._v(" "),t("ul",[t("li",[t("strong",[a._v("canary 의 weight 조정 status 및 promotion 여부 실시간 조회")])])]),a._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("$ kubectl get canary account -w\n\nNAME      STATUS      WEIGHT   LASTTRANSITIONTIME\naccount   Succeeded   "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2021")]),a._v("-07-27T03:27:18Z\naccount   Progressing   "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2021")]),a._v("-07-27T05:14:48Z\naccount   Progressing   "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("20")]),a._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2021")]),a._v("-07-27T05:15:49Z\naccount   Progressing   "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("40")]),a._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2021")]),a._v("-07-27T05:16:18Z\naccount   Progressing   "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("60")]),a._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2021")]),a._v("-07-27T05:16:48Z\naccount   Progressing   "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2021")]),a._v("-07-27T05:17:18Z\naccount   Promoting     "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2021")]),a._v("-07-27T05:17:48Z\naccount   Finalising    "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2021")]),a._v("-07-27T05:18:18Z\naccount   Succeeded     "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2021")]),a._v("-07-27T05:18:48Z\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br")])]),t("ul",[t("li",[t("strong",[a._v("Success Process 의 canary status 예시")])])]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("canaryWeight")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("conditions")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("lastTransitionTime")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"2021-07-27T03:27:18Z"')]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("lastUpdateTime")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"2021-07-27T03:27:18Z"')]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("message")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Canary analysis completed successfully"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" promotion finished.\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("reason")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Succeeded\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"True"')]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Promoted\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("failedChecks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("iterations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("lastAppliedSpec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 6c67dd598f\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("lastTransitionTime")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"2021-07-27T03:27:18Z"')]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("phase")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Succeeded\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("trackedConfigs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("configmap/account")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" f537fc97adad7769\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("configmap/xray-sampling-rules")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" b6fc9ea0629f67d0\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br")])]),t("h3",{attrs:{id:"analysis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#analysis"}},[a._v("#")]),a._v(" analysis")]),a._v(" "),t("p",[a._v("release version 을 배포하여 해당 application 의 promotion 관련 설정을, analysis 를 통해 정의한다. 배포 전략이 여기서 정의된다.")]),a._v(" "),t("blockquote",[t("p",[a._v("The canary analysis defines:")]),a._v(" "),t("blockquote",[t("ul",[t("li",[a._v("the type of deployment strategy")]),a._v(" "),t("li",[a._v("the metrics used to validate the canary version")]),a._v(" "),t("li",[a._v("the webhooks used for conformance testing, load testing and manual gating")]),a._v(" "),t("li",[a._v("the alerting settings")])])])]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[a._v("  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("analysis")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# schedule interval (default 60s)")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# max number of failed metric checks before rollback")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("threshold")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# max traffic percentage routed to canary")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# percentage (0-100)")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("maxWeight")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# canary increment step")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# percentage (0-100)")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stepWeight")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# promotion increment step")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# percentage (0-100)")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stepWeightPromotion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# total number of iterations")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# used for A/B Testing and Blue/Green")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("iterations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# canary match conditions")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# used for A/B Testing")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("match")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# HTTP header")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# key performance indicators")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metrics")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# metric check")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# alerting")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("alerts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# alert provider")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# external checks")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("webhooks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# hook")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br"),t("span",{staticClass:"line-number"},[a._v("23")]),t("br"),t("span",{staticClass:"line-number"},[a._v("24")]),t("br"),t("span",{staticClass:"line-number"},[a._v("25")]),t("br"),t("span",{staticClass:"line-number"},[a._v("26")]),t("br"),t("span",{staticClass:"line-number"},[a._v("27")]),t("br"),t("span",{staticClass:"line-number"},[a._v("28")]),t("br"),t("span",{staticClass:"line-number"},[a._v("29")]),t("br"),t("span",{staticClass:"line-number"},[a._v("30")]),t("br")])]),t("h2",{attrs:{id:"deployment-strategy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#deployment-strategy"}},[a._v("#")]),a._v(" Deployment Strategy")]),a._v(" "),t("p",[a._v("Flagger 의 canary analysis 정의를 통하여, 다양한 방식의 배포 전략을 고려할 수 있다."),t("br"),a._v("\nService Mesh 상에 설치된 Flagger 에 의해서, Canary Release, Blue/Green Deployment 가 실행되는 경우에 대한 좀 더 상세한 정리 내역이다.")]),a._v(" "),t("p",[a._v("Canary Analysis 작업은 아래 object 의 변경 event 에 의해 trigger 됨.")]),a._v(" "),t("ul",[t("li",[a._v("Deployment PodSpec (container image, command, ports, env, resources, etc) 변경, 혹은 rollout restart")]),a._v(" "),t("li",[a._v("Volume 으로 mount 되었거나, 환경 변수로 mapping 된 ConfigMap 변경")]),a._v(" "),t("li",[a._v("Volume 으로 mount 된 Secret 변경")])]),a._v(" "),t("h3",{attrs:{id:"canary-release"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#canary-release"}},[a._v("#")]),a._v(" Canary Release")]),a._v(" "),t("p",[a._v("Flagger 는 http request success rate, duration 등을 측정하면서, traffic 을 canary object 로 점진적으로 이동시킨다."),t("br"),a._v("\n정의된 maximum traffic weight 에 도달하거나, check 실패 count 가 threshold 에 도달할 때까지, 주기적으로 traffic 을 이동시키고, 해당 release 의 promotion 이 가능한지 판단한다.")]),a._v(" "),t("p",[a._v("HTTP header, cookie 등을 활용하여, A/B Testing 을 통한 release 도 가능. (지원 가능한 service mesh, ingress controller 범위 내에서,,)")]),a._v(" "),t("ul",[t("li",[t("p",[t("strong",[a._v("Flagger 의 Canary Release 진행 단계 예시 (Max Weight: 50)")]),t("br"),a._v(" "),t("img",{attrs:{src:"https://raw.githubusercontent.com/fluxcd/flagger/main/docs/diagrams/flagger-canary-steps.png"}})])]),a._v(" "),t("li",[t("p",[t("strong",[a._v("Canary promotion stage 예시")])]),a._v(" "),t("ol",[t("li",[a._v("Canary deployment scan 및 새로운 Revision 감지")]),a._v(" "),t("li",[a._v("Primary, Canary deployment status 확인"),t("br"),a._v("\n: Rolling Update 진행 중인 경우, release 중단"),t("br"),a._v("\n: Pod 상태가 비정상적일 경우, release 중단"),t("br"),a._v(" "),t("code",[a._v("[confirm-rollout webhook]")]),t("br"),a._v(" "),t("code",[a._v("[pre-rollout webhook]")])]),a._v(" "),t("li",[a._v("정의된 stepWeight 에 따른 Canary traffic 증가 (maxWeight 에 도달할 때까지, 정의된 interval 에 따라,,)"),t("br"),a._v(" "),t("code",[a._v("[rollout webhook]")])]),a._v(" "),t("li",[a._v("(Optional) Webhook 에 정의된 Canary HTTP Request 실행 및 결과 확인"),t("br"),a._v("\n: HTTP request success rate / duration 등을 확인하여, metric 에 지정된 임계값 미만인 경우, release 중단"),t("br"),a._v("\n: rollout webhook 을 활용할 경우, weight 가 증가할 때 마다, webhook call API 를 통하여 canary 상태 check 가능"),t("br"),a._v(" "),t("code",[a._v("[confirm-promotion webhook]")])]),a._v(" "),t("li",[a._v("Promote canary to primary"),t("br"),a._v("\n: ConfigMap, Secret 을 primary 로 복사"),t("br"),a._v("\n: Deployment spec template 을 primary 로 복사")]),a._v(" "),t("li",[a._v("Primary Deployment rolling update"),t("br"),a._v("\n: Pod 상태가 비정상적일 경우, rolling update 중단")]),a._v(" "),t("li",[a._v("모든 Traffic 을 primary 로 routing")]),a._v(" "),t("li",[a._v("Canary Release scale 을 0 으로 확장")]),a._v(" "),t("li",[a._v("Rollout 상태 종료"),t("br"),a._v(" "),t("code",[a._v("[post-rollout webhook]")])]),a._v(" "),t("li",[a._v("(Optional) AlertProvider 에 의해Canary analysis 결과 alert 을 전송")])])])]),a._v(" "),t("br"),a._v(" "),t("ul",[t("li",[t("strong",[a._v("추가 확인 내역")])])]),a._v(" "),t("ol",[t("li",[t("u",[t("em",[a._v("skipAnalysis=true")])]),a._v(" 로 정의할 경우, canary analysis 가 수행되지 않으며, canary release version 을 곧바로 promotion 한다. configmap, secret 변경 등을 감지하여 deployment 를 자동으로 restart 할 수 있는 용도로도 활용 가능할 것으로 보임.")]),a._v(" "),t("li",[a._v("configmap, secretmap 을 copy 하여 관리하는 기능은, flagger 설치 시 disable 가능.")])]),a._v(" "),t("h3",{attrs:{id:"blue-green-deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#blue-green-deployment"}},[a._v("#")]),a._v(" Blue/Green Deployment")]),a._v(" "),t("p",[a._v("stepWeight/maxWeight 의 정의를 interation 으로 대체하여, Blue/Green 배포 전략을 쉽게 달성할 수 있다."),t("br"),a._v("\nService Mesh 환경이 아닐 경우에는, Flagger 에서 Kubernetes 기본 L4 Networking 을 통하여, Blue/Green 배포를 할 수 있도록 지원한다.")]),a._v(" "),t("ul",[t("li",[t("p",[t("strong",[a._v("Flagger Blue/Green Deployment 단계 예시")]),t("br"),a._v(" "),t("img",{attrs:{src:"https://raw.githubusercontent.com/fluxcd/flagger/main/docs/diagrams/flagger-bluegreen-steps.png"}})])]),a._v(" "),t("li",[t("p",[t("strong",[a._v("Blue/Green analysis 정의 예시")]),t("br"),a._v("\n: 아래 처럼 구성할 경우, 10분 동안 canary pod 의 적합성 및 부하 테스트를 webhook 호출에 의해서 자동으로 실행하거나, 혹은 수동으로 테스트를 진행할 수 있다. Canary Release 와 동일하게 metric 정의에서 실패한 경우 실패 counter 가 증가하여, threshold 기준에 도달할 경우 release 가 중단된다.")])])]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[a._v("  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("analysis")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# schedule interval (default 60s)")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 1m\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# total number of iterations")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("iterations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# max number of failed iterations before rollback")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("threshold")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br")])]),t("br"),a._v(" "),t("ul",[t("li",[t("p",[t("strong",[a._v("Blue/Green rollout stage 예시")])]),a._v(" "),t("ol",[t("li",[a._v("Canary deployment scan 및 새로운 Revision 감지")]),a._v(" "),t("li",[a._v("Canary Deployment scale up (Green)")]),a._v(" "),t("li",[a._v("Canary Pod 에 대한 테스트 수행"),t("br"),a._v("\n: 실패 임계 값에 도달하면 release 중단")]),a._v(" "),t("li",[a._v("Canary 로 모든 traffic routing")]),a._v(" "),t("li",[a._v("Canary spec 을 primary 로 복사 및 promote (Blue)")]),a._v(" "),t("li",[a._v("Primary rollout")]),a._v(" "),t("li",[a._v("Canary scale down")])])])]),a._v(" "),t("p",[t("u",[t("em",[a._v("모든 analysis 작업이 완료되고, traffic 을 canary (Green) 환경으로 traffic routing 처리를 한 후에, primary 를 rollout 하므로, request 가 유실되는 것을 방지할 수 있다.")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);