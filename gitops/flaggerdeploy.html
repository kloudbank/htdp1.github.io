<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Flagger on EKS App Mesh | HTDP1</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="htdp1 github pages">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/am-arch/assets/css/0.styles.cf1d3b34.css" as="style"><link rel="preload" href="/am-arch/assets/js/app.89e1056e.js" as="script"><link rel="preload" href="/am-arch/assets/js/2.158b03bb.js" as="script"><link rel="preload" href="/am-arch/assets/js/8.8c182984.js" as="script"><link rel="prefetch" href="/am-arch/assets/js/10.f985dceb.js"><link rel="prefetch" href="/am-arch/assets/js/11.13a0885b.js"><link rel="prefetch" href="/am-arch/assets/js/12.784f5764.js"><link rel="prefetch" href="/am-arch/assets/js/13.0705463a.js"><link rel="prefetch" href="/am-arch/assets/js/14.edf1e9bf.js"><link rel="prefetch" href="/am-arch/assets/js/15.ecbe92b4.js"><link rel="prefetch" href="/am-arch/assets/js/16.b0e5273b.js"><link rel="prefetch" href="/am-arch/assets/js/17.c1412e8f.js"><link rel="prefetch" href="/am-arch/assets/js/18.2bf38a43.js"><link rel="prefetch" href="/am-arch/assets/js/19.d66be9cb.js"><link rel="prefetch" href="/am-arch/assets/js/20.2d12a517.js"><link rel="prefetch" href="/am-arch/assets/js/21.4a5538a4.js"><link rel="prefetch" href="/am-arch/assets/js/22.b2655bc9.js"><link rel="prefetch" href="/am-arch/assets/js/23.f69f4766.js"><link rel="prefetch" href="/am-arch/assets/js/24.d9cb860d.js"><link rel="prefetch" href="/am-arch/assets/js/25.7a3200a9.js"><link rel="prefetch" href="/am-arch/assets/js/26.5cb3a254.js"><link rel="prefetch" href="/am-arch/assets/js/27.0c63f9e7.js"><link rel="prefetch" href="/am-arch/assets/js/28.58281d66.js"><link rel="prefetch" href="/am-arch/assets/js/29.164199d9.js"><link rel="prefetch" href="/am-arch/assets/js/3.0b98036c.js"><link rel="prefetch" href="/am-arch/assets/js/30.495713a6.js"><link rel="prefetch" href="/am-arch/assets/js/31.4507fc8d.js"><link rel="prefetch" href="/am-arch/assets/js/32.e2d5f511.js"><link rel="prefetch" href="/am-arch/assets/js/33.5a7d28a0.js"><link rel="prefetch" href="/am-arch/assets/js/34.24927452.js"><link rel="prefetch" href="/am-arch/assets/js/35.b946ec72.js"><link rel="prefetch" href="/am-arch/assets/js/36.3e0df84b.js"><link rel="prefetch" href="/am-arch/assets/js/37.baf5ac72.js"><link rel="prefetch" href="/am-arch/assets/js/38.924d0d58.js"><link rel="prefetch" href="/am-arch/assets/js/39.c9ada2db.js"><link rel="prefetch" href="/am-arch/assets/js/4.3bf6929e.js"><link rel="prefetch" href="/am-arch/assets/js/40.59ff4950.js"><link rel="prefetch" href="/am-arch/assets/js/41.e36e5e29.js"><link rel="prefetch" href="/am-arch/assets/js/42.8fbd702b.js"><link rel="prefetch" href="/am-arch/assets/js/43.682ed0be.js"><link rel="prefetch" href="/am-arch/assets/js/44.e96bd250.js"><link rel="prefetch" href="/am-arch/assets/js/45.e5548ca0.js"><link rel="prefetch" href="/am-arch/assets/js/46.eb3135d2.js"><link rel="prefetch" href="/am-arch/assets/js/47.75bfb6d8.js"><link rel="prefetch" href="/am-arch/assets/js/48.24475551.js"><link rel="prefetch" href="/am-arch/assets/js/49.4f9d97da.js"><link rel="prefetch" href="/am-arch/assets/js/5.612537aa.js"><link rel="prefetch" href="/am-arch/assets/js/50.9396ae6a.js"><link rel="prefetch" href="/am-arch/assets/js/51.0246b6e3.js"><link rel="prefetch" href="/am-arch/assets/js/52.b63d5ce3.js"><link rel="prefetch" href="/am-arch/assets/js/53.1f0c3f8c.js"><link rel="prefetch" href="/am-arch/assets/js/54.945e81a6.js"><link rel="prefetch" href="/am-arch/assets/js/55.7f8cfc43.js"><link rel="prefetch" href="/am-arch/assets/js/56.c5892f1b.js"><link rel="prefetch" href="/am-arch/assets/js/57.95dda11c.js"><link rel="prefetch" href="/am-arch/assets/js/58.5239fcca.js"><link rel="prefetch" href="/am-arch/assets/js/59.8c2edf4b.js"><link rel="prefetch" href="/am-arch/assets/js/6.744bf98a.js"><link rel="prefetch" href="/am-arch/assets/js/60.41a76796.js"><link rel="prefetch" href="/am-arch/assets/js/61.26101a83.js"><link rel="prefetch" href="/am-arch/assets/js/62.f17e7ccd.js"><link rel="prefetch" href="/am-arch/assets/js/63.26013c6d.js"><link rel="prefetch" href="/am-arch/assets/js/64.5a311c5f.js"><link rel="prefetch" href="/am-arch/assets/js/65.eb28022b.js"><link rel="prefetch" href="/am-arch/assets/js/7.fed2825e.js"><link rel="prefetch" href="/am-arch/assets/js/9.3fd7e149.js">
    <link rel="stylesheet" href="/am-arch/assets/css/0.styles.cf1d3b34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/am-arch/" class="home-link router-link-active"><!----> <span class="site-name">HTDP1</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/am-arch/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/am-arch/cloud/" class="nav-link">
  Cloud
</a></div><div class="nav-item"><a href="/am-arch/refarch/" class="nav-link">
  Ref. Arch.
</a></div><div class="nav-item"><a href="/am-arch/cloud-native-app/" class="nav-link">
  Cloud.Native.App
</a></div><div class="nav-item"><a href="/am-arch/machinelearning/" class="nav-link">
  M / L
</a></div><div class="nav-item"><a href="/am-arch/gitops/" class="nav-link router-link-active">
  GitOps
</a></div><div class="nav-item"><a href="/am-arch/multi-cloud/" class="nav-link">
  Multi Cloud
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/am-arch/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/am-arch/cloud/" class="nav-link">
  Cloud
</a></div><div class="nav-item"><a href="/am-arch/refarch/" class="nav-link">
  Ref. Arch.
</a></div><div class="nav-item"><a href="/am-arch/cloud-native-app/" class="nav-link">
  Cloud.Native.App
</a></div><div class="nav-item"><a href="/am-arch/machinelearning/" class="nav-link">
  M / L
</a></div><div class="nav-item"><a href="/am-arch/gitops/" class="nav-link router-link-active">
  GitOps
</a></div><div class="nav-item"><a href="/am-arch/multi-cloud/" class="nav-link">
  Multi Cloud
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Introduction</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/am-arch/gitops/" aria-current="page" class="sidebar-link">Overview</a></li><li><a href="/am-arch/gitops/gitopsintro.html" class="sidebar-link">GitOps</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>FluxCD</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/am-arch/gitops/fluxintro.html" class="sidebar-link">Basics</a></li><li><a href="/am-arch/gitops/fluxcdv2.html" class="sidebar-link">Flux v2 with AWS Managed Services</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Flagger</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/am-arch/gitops/flaggerintro.html" class="sidebar-link">Basics</a></li><li><a href="/am-arch/gitops/flaggerdeploy.html" aria-current="page" class="active sidebar-link">Flagger on EKS App Mesh</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/am-arch/gitops/flaggerdeploy.html#prerequisite" class="sidebar-link">Prerequisite</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/am-arch/gitops/flaggerdeploy.html#install-app-mesh-components" class="sidebar-link">Install App Mesh Components</a></li><li class="sidebar-sub-header"><a href="/am-arch/gitops/flaggerdeploy.html#install-flagger" class="sidebar-link">Install Flagger</a></li></ul></li><li class="sidebar-sub-header"><a href="/am-arch/gitops/flaggerdeploy.html#service-mesh-canary-release" class="sidebar-link">Service Mesh Canary release</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/am-arch/gitops/flaggerdeploy.html#app-mesh-flagger" class="sidebar-link">App Mesh + Flagger</a></li><li class="sidebar-sub-header"><a href="/am-arch/gitops/flaggerdeploy.html#flagger-canary-resource" class="sidebar-link">Flagger Canary resource</a></li><li class="sidebar-sub-header"><a href="/am-arch/gitops/flaggerdeploy.html#automated-canary-promotion" class="sidebar-link">Automated Canary Promotion</a></li><li class="sidebar-sub-header"><a href="/am-arch/gitops/flaggerdeploy.html#test-result" class="sidebar-link">Test Result</a></li></ul></li><li class="sidebar-sub-header"><a href="/am-arch/gitops/flaggerdeploy.html#ingress-canary-release" class="sidebar-link">Ingress Canary Release</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ArgoCD</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/am-arch/gitops/argocdintro.html" class="sidebar-link">Basics</a></li><li><a href="/am-arch/gitops/argocddeploy.html" class="sidebar-link">ArgoCD 실습</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="flagger-on-eks-app-mesh"><a href="#flagger-on-eks-app-mesh" class="header-anchor">#</a> Flagger on EKS App Mesh</h1> <p>AWS 에서 제공하는 Service Mesh 인 Amazon App Mesh 에서, Flagger 를 활용한 Kubernetes Object Delivery 환경 구성 및 FluxCD 기반 Amazon EKS GitOps 환경과의 통합.</p> <ul><li><p>App Mesh integration with Amazon EKS</p> <ul><li>Kubernetes custom resources : mesh, virtual nodes, routers, services 활용 (외부 노출을 위한 Virtual Gateway 는 제외)</li> <li>CRD controller : App Mesh control plane 과 custom resource 의 동기화</li> <li>Admission controller : Envoy sidecar injection 과 App Mesh virtual nodes 에 service (pod) assign</li> <li>Telemetry service : appmesh 에서 제공하는 prometheus 활용</li> <li>Progressive delivery operator : Flagger instance 를 활용한 canary release automation</li></ul></li></ul> <img src="https://eks.handson.flagger.dev/gitops-appmesh-stack.png"> <blockquote><p>EKS GitOps Handson 참조<br> <a href="https://eks.handson.flagger.dev/profile/#app-mesh-profile" target="_blank" rel="noopener noreferrer">https://eks.handson.flagger.dev/profile/#app-mesh-profile<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="prerequisite"><a href="#prerequisite" class="header-anchor">#</a> Prerequisite</h2> <ul><li><p>GitOps Pipeline</p> <ul><li>사전에 구성한 Amazon EKS cluster (ver. &gt;= 1.16)</li> <li>사전에 구성한 ECR</li> <li>사전에 구성한 AWS Code Pipeline (CodeCommit + CodeBuild)</li> <li>FluxCD 기반 k8s manifest repository 의 Pull based Deployment 환경</li></ul></li> <li><p>Delivery Process</p> <ul><li>App Mesh Component 및 Prometheus 설치</li> <li>Flagger 설치</li></ul></li></ul> <blockquote><p>Flagger Official Docs 참조<br> <a href="https://docs.flagger.app/install/flagger-install-on-eks-appmesh" target="_blank" rel="noopener noreferrer">https://docs.flagger.app/install/flagger-install-on-eks-appmesh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="install-app-mesh-components"><a href="#install-app-mesh-components" class="header-anchor">#</a> Install App Mesh Components</h3> <ul><li>Helm repository 추가</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>helm repo <span class="token function">add</span> eks https://aws.github.io/eks-charts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>App Mesh CRD 설치 및 namespace 생성:</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl apply -k github.com/aws/eks-charts/stable/appmesh-controller//crds?ref<span class="token operator">=</span>master

kubectl create ns appmesh-system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>App Mesh controller helm install</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>helm upgrade -i appmesh-controller eks/appmesh-controller <span class="token punctuation">\</span>
--wait --namespace appmesh-system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>App Mesh Prometheus helm install<br>
: Flagger 의 canary analysis 를 위해 필요한, App Mesh metric 수집을 위해 설치</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>helm upgrade -i appmesh-prometheus eks/appmesh-prometheus <span class="token punctuation">\</span>
--wait --namespace appmesh-system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="install-flagger"><a href="#install-flagger" class="header-anchor">#</a> Install Flagger</h3> <ul><li>Helm repository 추가</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>helm repo <span class="token function">add</span> flagger https://flagger.app
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>Flagger CRD 설치<br>
: Canary, AlertProvider, MetricTemplate,,</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl apply -f https://raw.githubusercontent.com/fluxcd/flagger/main/artifacts/flagger/crd.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>App Mesh namespace 에 flagger helm install</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>helm upgrade -i flagger flagger/flagger <span class="token punctuation">\</span>
--namespace<span class="token operator">=</span>appmesh-system <span class="token punctuation">\</span>
--set crd.create<span class="token operator">=</span>false <span class="token punctuation">\</span>
--set <span class="token assign-left variable">meshProvider</span><span class="token operator">=</span>appmesh:v1beta2 <span class="token punctuation">\</span>
--set <span class="token assign-left variable">metricsServer</span><span class="token operator">=</span>http://appmesh-prometheus:9090
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>Monitoring 을 위한, Flagger Grafana helm install</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>helm upgrade -i flagger-grafana flagger/grafana <span class="token punctuation">\</span>
--set <span class="token assign-left variable">url</span><span class="token operator">=</span>http://prometheus:9090
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="service-mesh-canary-release"><a href="#service-mesh-canary-release" class="header-anchor">#</a> Service Mesh Canary release</h2> <p>Service Mesh 기반 Flagger 의 Canary Release 에 대한 구성 내역.<br>
Flagger 의 Canary custom resource 를 정의하여, Amazon App Mesh 기반의 canary release automation process 를 구성하였다.</p> <blockquote><p>Flagger Official Docs 참조<br> <a href="https://docs.flagger.app/tutorials/appmesh-progressive-delivery" target="_blank" rel="noopener noreferrer">https://docs.flagger.app/tutorials/appmesh-progressive-delivery<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="app-mesh-flagger"><a href="#app-mesh-flagger" class="header-anchor">#</a> App Mesh + Flagger</h3> <p>Flagger 는 Canary resource 에 정의된 target deployment 및 hpa 를 기반으로, primary 기준이 되는 deployment, service, hpa 등을 생성하는 것 뿐 아니라, 정의된 provider 에 맞는 service mesh 에 필요한 custom resource 를 생성한다.</p> <p>App Mesh 의 경우, 수동으로 환경을 구성할 경우, Mesh, VirtualNode, VirtualService, VirtualRouter 등을 직접 k8s manifest 정의하고 apply 하여 생성해야 한다.<br>
하지만, Flagger 의 Canary resource 를 활용하여 정의할 경우, 관련된 primary, canary route 를 위한 virtual node, service, router 를 자동으로 생성해주므로, App Mesh 구성을 위해 global 영역의 논리적 경계를 정의하는 mesh 만 직접 생성하였다.</p> <ul><li><strong>Mesh resource manifest</strong></li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> appmesh.k8s.aws/v1beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Mesh
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> global
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">appmesh.k8s.aws/sidecarInjectorWebhook</span><span class="token punctuation">:</span> enabled
  <span class="token key atrule">egressFilter</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> ALLOW_ALL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><strong>Virtual node, router, service 를 직접 생성할 경우 예시</strong></li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token comment"># VirtualNode: k8s service 의 logical pointer 역할</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> appmesh.k8s.aws/v1beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualNode
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>shop
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>shop
  <span class="token key atrule">listeners</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">portMapping</span><span class="token punctuation">:</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> tcp
  <span class="token key atrule">serviceDiscovery</span><span class="token punctuation">:</span>
    <span class="token key atrule">dns</span><span class="token punctuation">:</span> <span class="token comment"># service 지정</span>
      <span class="token key atrule">hostname</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>shop.shop<span class="token punctuation">-</span>infra.svc.cluster.local.

<span class="token punctuation">---</span>
<span class="token comment"># VirtualRouter: VirtualService 의 traffic 을 VirtualNode 로 routing</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> appmesh.k8s.aws/v1beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualRouter
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>shop
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">listeners</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">portMapping</span><span class="token punctuation">:</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> tcp
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> route<span class="token punctuation">-</span>to<span class="token punctuation">-</span>mariadb<span class="token punctuation">-</span>shop
    <span class="token key atrule">tcpRoute</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span>
        <span class="token key atrule">weightedTargets</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">virtualNodeRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>shop
          <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token punctuation">---</span>
<span class="token comment"># VirtualService: 실제 k8s service 를 추상화한 object. service name 과 동일하게 생성</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> appmesh.k8s.aws/v1beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>shop
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">awsName</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>shop.shop<span class="token punctuation">-</span>infra
  <span class="token key atrule">provider</span><span class="token punctuation">:</span>
    <span class="token key atrule">virtualRouter</span><span class="token punctuation">:</span>
      <span class="token key atrule">virtualRouterRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>shop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><ul><li><strong>App Mesh Traffic Flow 예시</strong></li></ul> <img src="https://docs.aws.amazon.com/app-mesh/latest/userguide/images/simple-app-with-mesh-diagram.png"> <blockquote><p>Amazon App Mesh Official Docs 참조<br> <a href="https://docs.aws.amazon.com/app-mesh/latest/userguide/what-is-app-mesh.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/app-mesh/latest/userguide/what-is-app-mesh.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="flagger-canary-resource"><a href="#flagger-canary-resource" class="header-anchor">#</a> Flagger Canary resource</h3> <p>기존에 FluxCD 기반으로 배포되어 있던, deployment, hpa 구성을 target 으로 하는 Canary Resource 를 생성한 내역</p> <ul><li><strong>Canary resource manifest 예시</strong></li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> flagger.app/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Canary
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> &lt;name<span class="token punctuation">&gt;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">provider</span><span class="token punctuation">:</span> appmesh<span class="token punctuation">:</span>v1beta2
  <span class="token comment"># target deployment 정의</span>
  <span class="token key atrule">targetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> &lt;name<span class="token punctuation">&gt;</span>
  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span>
  <span class="token comment"># target hpa 정의</span>
  <span class="token key atrule">autoscalerRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta2
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
    <span class="token key atrule">name</span><span class="token punctuation">:</span> &lt;name<span class="token punctuation">&gt;</span>
  <span class="token comment"># expose 를 위한 service 정의 (ClusterIP)</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> &lt;port<span class="token punctuation">&gt;</span>
    <span class="token key atrule">backends</span><span class="token punctuation">:</span> <span class="token comment"># App Mesh 일 경우, virtual service egress 허용을 위해 추가해주어야 하는 내용</span>
      <span class="token punctuation">-</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>appmesh<span class="token punctuation">:</span>ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2<span class="token punctuation">:</span>170247361816<span class="token punctuation">:</span>mesh/global/virtualService/mariadb<span class="token punctuation">-</span>shop.shop<span class="token punctuation">-</span>infra
      <span class="token punctuation">-</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>appmesh<span class="token punctuation">:</span>ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2<span class="token punctuation">:</span>170247361816<span class="token punctuation">:</span>mesh/global/virtualService/rabbitmq.shop<span class="token punctuation">-</span>infra
      <span class="token punctuation">-</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>appmesh<span class="token punctuation">:</span>ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2<span class="token punctuation">:</span>170247361816<span class="token punctuation">:</span>mesh/global/virtualService/redis<span class="token punctuation">-</span>session.shop<span class="token punctuation">-</span>infra
  <span class="token comment"># canary analysis 정의 영역</span>
  <span class="token key atrule">skipAnalysis</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># true 일 경우, 곧바로 canary promotion</span>
  <span class="token key atrule">analysis</span><span class="token punctuation">:</span>
    <span class="token comment"># schedule interval (default 60s)</span>
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s
    <span class="token comment"># max number of failed metric checks before rollback</span>
    <span class="token key atrule">threshold</span><span class="token punctuation">:</span> <span class="token number">3</span>
    <span class="token comment"># 도달하기 위한 최대 가중치 값 정의, percentage (0-100)</span>
    <span class="token key atrule">maxWeight</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token comment"># traffic 가중치 증가 단위, percentage (0-100)</span>
    <span class="token key atrule">stepWeight</span><span class="token punctuation">:</span> <span class="token number">20</span>
    <span class="token comment"># App Mesh Prometheus 의 metric check</span>
    <span class="token comment">### flagger 의 service mesh metric check 는 기본적으로 아래의 2가지 항목을 제공</span>
    <span class="token comment">### request 성공률, duration</span>
    <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> request<span class="token punctuation">-</span>success<span class="token punctuation">-</span>rate
      <span class="token comment"># minimum req success rate (non 5xx responses), percentage (0-100)</span>
      <span class="token key atrule">thresholdRange</span><span class="token punctuation">:</span>
        <span class="token key atrule">min</span><span class="token punctuation">:</span> <span class="token number">99</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1m
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> request<span class="token punctuation">-</span>duration
      <span class="token comment"># maximum req duration P99, milliseconds</span>
      <span class="token key atrule">thresholdRange</span><span class="token punctuation">:</span>
        <span class="token key atrule">max</span><span class="token punctuation">:</span> <span class="token number">500</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s
    <span class="token comment"># 생성한 alert provider 를 reference 로 하여, slack channel 에 message 전송</span>
    <span class="token comment">### slack web hook url 기반으로 namespace 에 alert provider 미리 생성함.</span>
    <span class="token key atrule">alerts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;dev team Slack&quot;</span>
        <span class="token key atrule">severity</span><span class="token punctuation">:</span> info
        <span class="token key atrule">providerRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>call
          <span class="token key atrule">namespace</span><span class="token punctuation">:</span> shop
    <span class="token comment"># webhook 기반 Testing (optional)</span>
    <span class="token comment">### rollout type 으로 정의하여, weight 가 변경될 때 마다, curl command 를 호출하는 url 호출</span>
    <span class="token comment">### flagger-loadtester application 을 미리 배포하였음.</span>
    <span class="token key atrule">webhooks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> acceptance<span class="token punctuation">-</span>test
      <span class="token key atrule">type</span><span class="token punctuation">:</span> rollout
      <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//flagger<span class="token punctuation">-</span>loadtester.shop/
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 60s
      <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> bash
        <span class="token key atrule">cmd</span><span class="token punctuation">:</span> <span class="token string">&quot;curl -X GET http://account-canary.shop:8180/v1/accounts/events&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><ul><li><strong>Alert Provider 생성 manifest 예시</strong></li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> flagger.app/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AlertProvider
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>call
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> slack
  <span class="token key atrule">channel</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>call<span class="token punctuation">-</span>alerts
  <span class="token key atrule">username</span><span class="token punctuation">:</span> flagger
  <span class="token comment"># webhook address (ignored if secretRef is specified)</span>
  <span class="token key atrule">address</span><span class="token punctuation">:</span> &lt;webhook address<span class="token punctuation">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><strong>Canary resource 생성 시, generate 되는 object 내역</strong><br>
: app name 은 account</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># Flagger canary resource</span>
canary.flagger.app/account

<span class="token comment"># target deployment, hpa 의 primary object</span>
deployment.apps/account-primary
horizontalpodautoscaler.autoscaling/account-primary

<span class="token comment"># primary service 와 weight routing 을 위한 canary service</span>
service/account                ClusterIP
service/account-canary         ClusterIP
service/account-primary        ClusterIP

<span class="token comment"># App Mesh resource, AWS 의 arn 이 부여됨.</span>
virtualnode.appmesh.k8s.aws/account-canary       arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualNode/account-canary_shop
virtualnode.appmesh.k8s.aws/account-primary      arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualNode/account-primary_shop
virtualrouter.appmesh.k8s.aws/account            arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualRouter/account_shop
virtualrouter.appmesh.k8s.aws/account-canary     arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualRouter/account-canary_shop
virtualservice.appmesh.k8s.aws/account           arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualService/account.shop
virtualservice.appmesh.k8s.aws/account-canary    arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualService/account-canary.shop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="automated-canary-promotion"><a href="#automated-canary-promotion" class="header-anchor">#</a> Automated Canary Promotion</h3> <p>Spring Boot Application 의 application property 를 configmap volume 으로 mount 한 application 의 Canary release demo.</p> <h4 id="test-scenario"><a href="#test-scenario" class="header-anchor">#</a> Test Scenario</h4> <ol><li>k8s manifest git repository 의, spring boot application property 를 수정 후 commit &amp; push.</li> <li>FluxCD 에 의해서, kustomize reconciliation 수행하여, k8s configmap 재생성.</li> <li>Flagger 에서 configmap 의 변경 event 를 감지하여, canary release process 시작.</li> <li>Canary Release<br>
4-1. 변경된 configmap 으로 인해 application error 발생으로 pod 생성 실패<br>
4-2. alert provider 에 의해 slack message 수신</li> <li>k8s manifest git repository 의, spring boot application property 올바른 값으로 수정 및 commit &amp; push.</li> <li>2 ~ 4번 과정 다시 반복.</li> <li>Canary Release<br>
7-1. request-success-rate metric 분석 threshold check 실패<br>
7-2. alert provider 에 의해 slack message 수신</li> <li>Flagger canary resource 의 metric threshold 조정</li> <li>Deployment rollout restart 수행.</li> <li>Alert provider 에 의해 slack message 수신.</li></ol> <img src="https://www.plantuml.com/plantuml/svg/bLLBRnen4BxxLpZqq8qKeArwg7fAIjeU-WWAwg6doDW3MFWbsqkILldl6NiVx9840WTszfllcnbxnklp49cFfLQ4BAoDuEcFSWxUG8H0fugPEFppwoS9d2cWcjtHz-y-VAItKiGL8M4jZMEUQMgiW00ElHtGCxEkGVAs4vUS25X80nreYXNGLOmkV1wFFRiTBMLSbVCoWEVMH31nnAqU2yu2YtAyReN3N2EMEDOiOFbZ8KCav4GQhae1fLSxMJhQcudLsfgHIyj_hGABkOl7I6PIEoKN4aIbsYUxcit6MsYsuGSJzHLJAuvKJFIn0dziYajmojxNYsSyMay7bx0P3IWBD7NuGaaMIBIEHaldDaQhgP0UU9JM429OP7CMW0xMdmB5mQ0UdCrg1F2T56-2Odnzcg1izUUDOf-TDJX4WKnKcSRaveijZM3-lk0LS4O7NK453axfVqBnzvjf28vnsEeMghmp0MNVq9XSjbHAU-qeWYqz1-HLnZ2DixTAONG41wVFYjQOtg8xFxNyzuBiuUNYs7A9yQhwijqfS3TRpKPkRHsPZJcNCrquDteX3Ovo4JOyRGFuZUJGM_mpp0vro9d1D8SKhgDmNkfzahHgPPb0Co8dcSDaxpHbL-AiG3V-7sAvYdQmZkfe528_a5GPhwExbdympKGNNACJsxf0fjjFT0rpYTJ3iRqegWObsVvE9IxU8pxjUNvYTBkHOcVC7WYv1bMqduQpwfYV3IXIagT-tpbQbECbHF6cCZMjzZU7oTWeHqs4ZELDkGPSB9UOA7rkq5zfqx3cEMopDf3hGOYbiUX2BaCrBOE9WSbQKdQddTvIKYtRW_WT8lswmIzMBKZUkZDvYobkdBQvOCGcLzE_JPmsHZjKJTBMqxRhYQTp9fxuciQr5JS9gbFHyDlXh8z17s_AUirAcZAhxyOjoEKgqXKpGa6pArl6bfB2uDNa0Q-CfppNumbeUPcuNN-Lj5rhlVXykJJuEHY1TzeZ" alt="kubernetes"> <h3 id="test-result"><a href="#test-result" class="header-anchor">#</a> Test Result</h3> <p>Case 별 Test 내역 정리.</p> <h4 id="_1-configmap-변경에-의한-canary-release"><a href="#_1-configmap-변경에-의한-canary-release" class="header-anchor">#</a> 1.Configmap 변경에 의한, Canary release</h4> <ul><li>잘못된 db connection 설정하여 git commit &amp; push.</li></ul> <div class="language-git line-numbers-mode"><pre class="language-git"><code><span class="token command">$ git diff HEAD^ HEAD</span>

<span class="token deleted">--- a/clusters/eks/shop/prd/account/application-prd.yml</span>
<span class="token inserted">+++ b/clusters/eks/shop/prd/account/application-prd.yml</span>
@@ -11,7 +11,7 @@ spring:
     database-platform: org.hibernate.dialect.MariaDB103Dialect
   datasource:
     driver-class-name: org.mariadb.jdbc.Driver
<span class="token deleted">-    url: jdbc:mariadb://mariadb-shop.shop-infra/accounts?characterEncoding=UTF-8</span>
<span class="token inserted">+    url: jdbc:mariadb://mariadb-shop-new.shop-infra/accounts?characterEncoding=UTF-8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>FluxCD 에 의해 configmap account 만 변경 되고, 이로 인하여 Flagger 가 Canary release start<br>
: configmap 변경 영향으로, 새로 생성된 pod 에서 error 발생하여 canary release 불가.</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get cm

NAME                          DATA
account                       <span class="token number">2</span>   
account-primary               <span class="token number">2</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>Canary release alert 수신<br> <img src="/am-arch/assets/img/2021-07-28-14-46-57.ef624b29.png" width="40%" height="40%"></li></ul> <h4 id="_2-canary-analysis-metric-threshold-check-실패"><a href="#_2-canary-analysis-metric-threshold-check-실패" class="header-anchor">#</a> 2. Canary analysis metric threshold check 실패</h4> <p>threshold 100% 에 success rate 가 도달하지 못하여, canary release 실패.</p> <ul><li>canary describe 내역<br>
: controller 에서 log 내역으로도 확인 가능하며, canary resource 의 status monitoring 도 가능.</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>$ kubectl <span class="token keyword">describe</span> canary

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

Events:
  <span class="token keyword">Type</span>     Reason  Age                <span class="token keyword">From</span>     Message
  <span class="token comment">----     ------  ----               ----     -------</span>
  Normal   Synced  <span class="token number">50</span>m                flagger  Copying account<span class="token punctuation">.</span>shop template spec <span class="token keyword">to</span> account<span class="token operator">-</span><span class="token keyword">primary</span><span class="token punctuation">.</span>shop
  Normal   Synced  <span class="token number">49</span>m                flagger  Routing <span class="token keyword">all</span> traffic <span class="token keyword">to</span> <span class="token keyword">primary</span>
  Normal   Synced  <span class="token number">49</span>m                flagger  Promotion completed<span class="token operator">!</span> Scaling down account<span class="token punctuation">.</span>shop
  Normal   Synced  <span class="token number">32</span>m <span class="token punctuation">(</span>x2 <span class="token keyword">over</span> <span class="token number">52</span>m<span class="token punctuation">)</span>  flagger  New revision detected<span class="token operator">!</span> Scaling up account<span class="token punctuation">.</span>shop
  Normal   Synced  <span class="token number">31</span>m <span class="token punctuation">(</span>x2 <span class="token keyword">over</span> <span class="token number">51</span>m<span class="token punctuation">)</span>  flagger  Advance account<span class="token punctuation">.</span>shop canary weight <span class="token number">25</span>
  Normal   Synced  <span class="token number">31</span>m <span class="token punctuation">(</span>x2 <span class="token keyword">over</span> <span class="token number">51</span>m<span class="token punctuation">)</span>  flagger  <span class="token keyword">Starting</span> canary analysis <span class="token keyword">for</span> account<span class="token punctuation">.</span>shop
  Normal   Synced  <span class="token number">30</span>m <span class="token punctuation">(</span>x2 <span class="token keyword">over</span> <span class="token number">50</span>m<span class="token punctuation">)</span>  flagger  Advance account<span class="token punctuation">.</span>shop canary weight <span class="token number">50</span>
  Warning  Synced  <span class="token number">30</span>m                flagger  Halt account<span class="token punctuation">.</span>shop advancement success rate <span class="token number">99.74</span><span class="token operator">%</span> <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token operator">%</span>
  Warning  Synced  <span class="token number">29</span>m                flagger  Halt account<span class="token punctuation">.</span>shop advancement success rate <span class="token number">99.54</span><span class="token operator">%</span> <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token operator">%</span>
  Warning  Synced  <span class="token number">29</span>m                flagger  Halt account<span class="token punctuation">.</span>shop advancement success rate <span class="token number">99.58</span><span class="token operator">%</span> <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token operator">%</span>
  Warning  Synced  <span class="token number">28</span>m                flagger  Halt account<span class="token punctuation">.</span>shop advancement success rate <span class="token number">99.61</span><span class="token operator">%</span> <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token operator">%</span>
  Warning  Synced  <span class="token number">28</span>m                flagger  Halt account<span class="token punctuation">.</span>shop advancement success rate <span class="token number">99.53</span><span class="token operator">%</span> <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token operator">%</span>
  Warning  Synced  <span class="token number">27</span>m                flagger  Halt account<span class="token punctuation">.</span>shop advancement success rate <span class="token number">99.66</span><span class="token operator">%</span> <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token operator">%</span>
  Warning  Synced  <span class="token number">26</span>m <span class="token punctuation">(</span>x3 <span class="token keyword">over</span> <span class="token number">27</span>m<span class="token punctuation">)</span>  flagger  Halt account<span class="token punctuation">.</span>shop advancement success rate <span class="token number">99.65</span><span class="token operator">%</span> <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token operator">%</span>
  Warning  Synced  <span class="token number">25</span>m                flagger  Rolling back account<span class="token punctuation">.</span>shop failed checks threshold reached <span class="token number">10</span>
  Warning  Synced  <span class="token number">25</span>m                flagger  <span class="token punctuation">(</span>combined <span class="token keyword">from</span> similar events<span class="token punctuation">)</span>: Canary failed<span class="token operator">!</span> Scaling down account<span class="token punctuation">.</span>shop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li>Flagger Dashboard 를 통한 Monitoring<br>
: appmesh 의 prometheus metric 을 활용. Flagger 도 마찬가지.</li></ul> <p><img src="/am-arch/assets/img/2021-07-28-14-58-10.598a4f77.png" alt=""></p> <ul><li>AWS X-ray Monitoring<br>
: 실제로 pod 간에 traffic 분산이 잘되었는지 확인하고, 어떤 pod 에서 error 가 발생하였는지 확인.<br>
: 아래 컴포넌트의 error 발생율 만큼, 붉은 색으로 표시됨.<br> <u><em>traffic 분산 처리가 정말로 잘 되는지 의심스러워서 확인해 봄,,</em></u></li></ul> <p><img src="/am-arch/assets/img/2021-07-28-15-06-22.b3dc3850.png" alt=""></p> <h4 id="_3-canary-analysis-metric-threshold-조정"><a href="#_3-canary-analysis-metric-threshold-조정" class="header-anchor">#</a> 3. Canary analysis metric threshold 조정</h4> <p>threshold 조정 후, Canary release 재시작.<br>
metric threshold 변경으로 인해, k8s canary resource 가 수정되었더라도, Pod Spec, configmap, secret 의 변경이 없으므로, flagger 가 canary release 를 자동으로 수행하지 않음.</p> <p>Deployment 를 rollout restart 하여 canary release start.</p> <ul><li>Canary analysis 의 threshold range 수정 후, git commit &amp; push<br>
: 이후, deployment restart.</li></ul> <div class="language-git line-numbers-mode"><pre class="language-git"><code>@@ -59,7 +59,7 @@ spec:
       # minimum req success rate (non 5xx responses)
       # percentage (0-100)
       thresholdRange:
<span class="token deleted">-        min: 100</span>
<span class="token inserted">+        min: 95</span>
       interval: 3m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>Canary status 확인<br>
: 정상적으로 metric threshold check 완료 되어, canary promotion 수행.</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>Events:
  Type     Reason  Age                  From     Message
  ----     ------  ----                 ----     -------
  Normal   Synced  5m54s (x3 over 68m)  flagger  New revision detected! Scaling up account.shop
  Warning  Synced  5m24s                flagger  canary deployment account.shop not ready: waiting for rollout to finish: 1 of 2 updated replicas are available
  Normal   Synced  4m54s (x3 over 68m)  flagger  Starting canary analysis for account.shop
  Normal   Synced  4m54s (x3 over 68m)  flagger  Advance account.shop canary weight 25
  Normal   Synced  3m54s (x3 over 67m)  flagger  Advance account.shop canary weight 50
  Normal   Synced  3m24s (x2 over 66m)  flagger  Copying account.shop template spec to account-primary.shop
  Normal   Synced  2m54s (x2 over 66m)  flagger  Routing all traffic to primary
  Normal   Synced  2m24s (x2 over 65m)  flagger  Promotion completed! Scaling down account.shop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>Slack message 수신<br>
: 시작 message, 정상 종료 message 수신</li></ul> <img src="/am-arch/assets/img/2021-07-28-15-18-39.dd0082d7.png" width="40%" height="40%"> <h2 id="ingress-canary-release"><a href="#ingress-canary-release" class="header-anchor">#</a> Ingress Canary Release</h2> <p>TBD</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/am-arch/gitops/flaggerintro.html" class="prev">
        Basics
      </a></span> <span class="next"><a href="/am-arch/gitops/argocdintro.html">
        Basics
      </a>
      →
    </span></p></div> </main></div></div><div class="global-ui"></div></div>
    <script src="/am-arch/assets/js/app.89e1056e.js" defer></script><script src="/am-arch/assets/js/2.158b03bb.js" defer></script><script src="/am-arch/assets/js/8.8c182984.js" defer></script>
  </body>
</html>
